<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Kn√∂delbrot</title>

  <meta http-equiv="Cross-Origin-Embedder-Policy" content="credentialless">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .container {
      background-color: #1e1e1e;
      padding: 30px 40px;
      border-radius: 15px;
      width: 320px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
    }

    h1 {
      margin-bottom: 20px;
      color: #bb86fc;
    }

    input {
      display: block;
      margin: 10px auto;
      padding: 12px;
      width: 80%;
      max-width: 280px;
      border-radius: 8px;
      border: 1px solid #333;
      background-color: #2a2a2a;
      color: #f0f0f0;
      text-align: center;
    }

    button {
      padding: 10px 20px;
      background-color: #bb86fc;
      color: #121212;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }

    button:hover {
      background-color: #9a63e0;
    }

    p a {
      color: #bb86fc;
      text-decoration: none;
    }

    p a:hover {
      text-decoration: underline;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // üîß Firebase-Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyBmnEMGPec-dzIANP0pvGT3Lbvm51zFjaY",
      authDomain: "knoedelbrot-1d1de.firebaseapp.com",
      projectId: "knoedelbrot-1d1de",
      storageBucket: "knoedelbrot-1d1de.firebasestorage.app",
      messagingSenderId: "906476242509",
      appId: "1:906476242509:web:989fbc20dee736f1eb7e04"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // üç™ Cookie-Funktion mit Domain + SameSite-Support
    function setCookie(name, value, days = 7) {
      const d = new Date();
      d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie =
        name + "=" + value +
        "; expires=" + d.toUTCString() +
        "; path=/" +
        "; domain=.kn√∂delbrot.de" +
        "; Secure; SameSite=None";
    }

    // üîô Redirect-Ziel aus URL (Standard: Startseite)
    const params = new URLSearchParams(window.location.search);
    const redirectURL = params.get("redirect") || "https://knoedelbrot.de/";

    // üìã Login-Formular verarbeiten
    document.getElementById("loginForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const fakeEmail = username + "@kn√∂delbrot.local";

      try {
        const userCredential = await signInWithEmailAndPassword(auth, fakeEmail, password);
        const docSnap = await getDoc(doc(db, "users", username));
        const bonus = docSnap.exists() ? docSnap.data().bonus : "none";

        setCookie("login", "1", 7);
        setCookie("username", username, 7);
        setCookie("bonus", bonus, 7);

        // ‚úÖ Zur√ºckleitung zur urspr√ºnglichen Seite
        window.location.href = redirectURL;
      } catch (error) {
        alert("Login fehlgeschlagen: " + error.message);
        console.error(error);
      }
    });

    // üîÅ Bereits eingeloggt? -> Direkt zur√ºck
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const username = user.email.split("@")[0];
        const docSnap = await getDoc(doc(db, "users", username));
        const bonus = docSnap.exists() ? docSnap.data().bonus : "none";

        setCookie("login", "1", 7);
        setCookie("username", username, 7);
        setCookie("bonus", bonus, 7);

        window.location.href = redirectURL;
      }
    });
  </script>

</head>

<body>
  <div class="container">
    <h1>Login</h1>
    <form id="loginForm">
      <input type="text" id="username" placeholder="Benutzername" required>
      <input type="password" id="password" placeholder="Passwort" required>
      <button type="submit">Login</button>
    </form>
    <p>Noch kein Konto? <a href="register.html">Registrieren</a></p>
  </div>
</body>

</html>